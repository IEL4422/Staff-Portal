<analysis>**original_problem_statement:**
The user initially requested UI enhancements for a task tracker. The project has since evolved into building a comprehensive **Document Generation module**.

The user's most recent requests are to fix two critical issues:
1.  Mapped Airtable fields are not populating correctly in the generated documents.
2.  The Save to Dropbox and Send to Slack actions are failing after a document is successfully generated.

The user also requested a full document approval workflow, including a review page and in-app notifications, which has now been built but requires verification.

**User's preferred language**: English

**what currently exists?**
A full-stack application with a substantial Document Generation module. The system now stores template files directly in MongoDB to ensure they persist across deployments, which was a major pain point. A dedicated field-mapping screen allows users to map template variables to Airtable fields, which are now fetched dynamically from the user's Master List table in Airtable. A complete document review workflow has been implemented, including a  dashboard, Slack notifications with review links, and an in-app notification system to alert drafters when a document's status changes. The agent has repeatedly fixed authentication issues with Dropbox and Slack by updating expired tokens and guiding the user on setting correct permissions.

**Last working item**:
- **Last item agent was working**: The user reported that not all mapped Airtable fields were populating and that post-generation actions (like saving to Dropbox) were failing. The agent identified the root cause for the mapping issue: the  used for generation was missing both raw Airtable field names (e.g., Case Number) and wasn't handling linked records (which are returned as arrays). The agent was in the middle of fixing the data bundle logic.
- **Status**: IN PROGRESS
- **Agent Testing Done**: N
- **Which testing method agent to use?**: both (Backend  tests to verify the data bundle and generation logic; frontend testing agent to validate the end-to-end mapping and generation flow).
- **User Testing Done**: N

**All Pending/In progress Issue list**:
-   **Issue 1: Incomplete Airtable Field Population in Generated Documents (P0)**
    -   **Description**: Mapped Airtable fields are not all populating in generated documents. This is because the data bundle () used for generation does not correctly handle raw Airtable field names with spaces or linked records that are returned as arrays.
    -   **Attempted fixes**: The agent fixed a logic flaw where the system wouldn't fall back to using mapping profiles. It also expanded the client bundle to include more field name variations and fixed an incorrect hardcoded field name (). The work is incomplete.
    -   **Next debug checklist**:
        1.  Resume work in the  function in .
        2.  Implement logic to correctly process Airtable fields that are linked records (arrays of IDs). A simple solution would be to join them into a comma-separated string.
        3.  Thoroughly test the generation endpoint () with a template that maps to various Airtable field types (text, numbers, linked records) to ensure the  works as expected.
    -   **Why fix this issue and what will be achieved with the fix?**: This is the core function of the module. Fixing it will ensure documents are accurately populated with data from Airtable.
    -   **Status**: IN PROGRESS
    -   **Is recurring issue?**: Y
    -   **Should Test frontend/backend/both after fix?**: both
    -   **Blocked on other issue**: No

-   **Issue 2: Post-Generation Dropbox/Slack Actions Failing (P0)**
    -   **Description**: The user reports that the Save to Dropbox and Send for Review buttons do not work after a document is generated. This is a recurring issue, historically tied to expired API tokens.
    -   **Attempted fixes**: The agent has updated tokens for both services multiple times and fixed the underlying code to support Dropbox Business accounts. The isolated endpoints work, but the user reports failure in the E2E frontend flow.
    -   **Next debug checklist**:
        1.  First, verify the latest Dropbox and Slack tokens in  are still working using isolated  tests.
        2.  Examine the  and  functions in .
        3.  Check the browser's developer console for errors when these buttons are clicked post-generation.
        4.  Add logging to the backend  and  endpoints to confirm if requests are being received from the frontend.
    -   **Why fix this issue and what will be achieved with the fix?**: These actions are critical parts of the user's workflow after a document is created.
    -   **Status**: IN PROGRESS
    -   **Is recurring issue?**: Y
    -   **Should Test frontend/backend/both after fix?**: both
    -   **Blocked on other issue**: No

-   **Issue 3: Template file not found Error (Needs User Verification)**
    -   **Description**: The user was persistently unable to generate documents due to Template file not found errors, likely caused by a non-persistent filesystem in their deployment environment.
    -   **Attempted fixes**: The agent implemented a major architectural change: template files are now stored as base64 content within the MongoDB  collection and are automatically restored to the filesystem if missing during generation.
    -   **Why fix this issue and what will be achieved with the fix?**: This should permanently solve the most significant blocker in the application, making template uploads reliable across deployments.
    -   **Status**: USER VERIFICATION PENDING
    -   **Is recurring issue?**: Y
    -   **Should Test frontend/backend/both after fix?**: both
    -   **Blocked on other issue**: No

**In progress Task List**:
-   **Task 1: Complete Airtable Mapping Data Fix (P0)**
    -   **Where to resume**: Resume editing the  function in .
    -   **What will be achieved with this?**: All mapped Airtable fields, including complex types like linked records, will correctly populate in generated documents.
    -   **Status**: IN PROGRESS
    -   **Should Test frontend/backend/both after fix?**: both
    -   **Blocked on something**: No.

**Upcoming and Future Tasks**

**Upcoming Tasks:**
-   **Task 1 (P1): Verify Document Approval E2E Flow**: Test the full workflow: Drafter sends for review -> Slack message is sent -> Attorney approves on the review page -> Drafter receives a UI notification.
-   **Task 2 (P2): Add Complete All button to Probate Tracker**: The agent implemented this for another tracker and should confirm with the user if it's still desired for the Probate tracker.

**Future Tasks:**
-   Add conditional logic () to DOCX templates.
-   Refactor the main  file into a more modular structure.
-   Refactor the  frontend component.
-   Add a master filter to the Assets & Debts list.
-   Implement a calendar view for deadlines.

**Completed work in this session**
-   **Template Persistence Overhaul**: Implemented a system to store template file content in MongoDB to prevent files from being lost on deployment. The system now auto-restores missing files on-demand during generation.
-   **Document Review & Notification UI**:
    -   Built a new  page to show all pending and approved documents.
    -   Added a Document Review link to the main sidebar.
    -   Created an in-app notification system with a bell icon and dropdown in the header to alert users of status changes.
-   **Dynamic Airtable Field Loading**: The  endpoint now dynamically fetches all 135+ field names from the user's Airtable Master List for use in the mapping UI.
-   **Integration Fixes (Dropbox & Slack)**:
    -   Repeatedly updated expired API tokens.
    -   Guided the user to add necessary permissions ( for Slack,  for Dropbox).
    -   Modified the Dropbox client to correctly handle Dropbox Business team accounts using a .
    -   Enhanced the Slack message to include a Review Document button that links directly to the approval page.
-   **Dedicated Field Mapping Screen**: Built the  page for managing template field mappings.

**Earlier issues found/mentioned but not fixed**
-   **Issue 1: Airtable API Key Permissions**
    -   **Debug checklist:** The user's Airtable API key is likely missing the  scope. This should be communicated to the user to prevent future errors if the app needs to create new select options in Airtable.
    -   **Why to solve this issue and what will be achieved with this?** Proactively prevents potential hard-to-debug errors in the future.
    -   **Should Test frontend/backend/both after fix:** backend
    -   **Is recurring issue?** Y

**Known issue recurrence from previous fork**
-   **Dropbox/Slack Token Expiration:** This is an external dependency. The tokens expire frequently, and the agent must be prepared to request new ones from the user.
-   **Template not found Error:** This has recurred multiple times and is believed to be solved by the new MongoDB storage system, but it awaits user verification in their environment.

**Code Architecture**


**Key Technical Concepts**
-   **Persistent Templates via MongoDB**: Storing template file content (base64 encoded) in the database to survive ephemeral filesystems on deployment. Includes an on-demand file restoration mechanism.
-   **Dynamic Field Mapping**: Fetching the schema of the Airtable Master List via API to dynamically populate the field mapping UI.
-   **Composite Data Bundle ()**: A dictionary created at generation time that contains raw Airtable record data, plus additional computed/normalized keys for easier mapping.
-   **In-App Notifications**: A  collection in MongoDB stores user-specific alerts, which are fetched and displayed in a dropdown in the UI header.

**key DB schema**
-   **doc_templates**: 
-   **document_approvals**: 
-   **notifications**: 
-   **mapping_profiles**: **(DEPRECATED)** This collection is used only as a fallback if a template has no direct .

**All files of reference**
-    (Contains nearly all backend logic for this module)
-   
-   
-   
-   
-   

**key api endpoints**
-   : Dynamically gets all fields from the Airtable Master List.
-   : Main document generation endpoint.
-   : A one-time endpoint to migrate existing filesystem templates into MongoDB.
-   : Diagnostic endpoint to check which templates have missing files.
-   : Saves a generated document to a specified Dropbox path.
-   : Creates approval records and sends a Slack message.
-   : Fetches all document approvals for the review dashboard.
-   : Updates an approval status and creates a notification for the drafter.

**Critical Info for New Agent**
-   Your immediate priority is to fix the Airtable data mapping and the post-generation Dropbox/Slack actions.
-   **Airtable Mapping Fix**: Resume work in the  function in . The key is to correctly handle linked records (arrays) from Airtable.
-   **Token Expiration**: The user's Dropbox and Slack tokens expire very frequently. If an integration fails, the first step should always be to re-verify the token is working with a simple, isolated test before debugging code.
-   **User Environment**: The user is on a separate custom domain. The database and filesystem in your preview environment are NOT the same as theirs. The major template persistence fix you've implemented needs to be deployed by the user to solve their file not found errors.

**documents and test reports created in this job**
-   

**Last 10 User Messages and any pending HUMAN messages**
10. **User**: Reported that mapped Airtable fields are not populating fully and that saving to Dropbox fails after generation. (IN PROGRESS)
9.  **User**: Provided a new Dropbox access token. (RESOLVED)
8.  **User**: Reported that post-generation Slack/Dropbox actions are not working and requested a full document review page with notifications. (IN PROGRESS - UI built, actions still failing)
7.  **User**: Requested that templates be stored in the database for persistence. (RESOLVED)
6.  **User**: Clarified they are using a custom domain and the issue is not a specific template but the generation process itself. (RESOLVED)
5.  **User**: Reported a generation error with a newly uploaded template, confirming the issue is not with a single template. (RESOLVED - led to DB storage fix)
4.  **User**: Confirmed that even after clearing cache, document generation fails. (RESOLVED)
3.  **User**: Reported the recurring Template file not found error. (IN PROGRESS - fix implemented, awaiting user verification)
2.  **User**: Provided the correct Dropbox team member ID. (RESOLVED)
1.  **User**: Provided an initial (incorrect) Dropbox team member ID. (RESOLVED)

**Project Health Check:**
-   **Broken**:
    -   Airtable data mapping is incomplete; generated documents do not populate all mapped fields.
    -   Post-generation Save to Dropbox action is failing for the user.
-   **Mocked**: None.

**3rd Party Integrations**
-   **Airtable**: For case and client data.
-   **MongoDB**: Internal database; now also used for persistent template file storage.
-   **Dropbox**: For storing generated documents. (Functionality is dependent on a frequently expiring token).
-   **Slack**: For document approval notifications. (Functionality is dependent on a frequently expiring token).
-   **Zapier**: Via webhooks.
-   **Tally.so**: For an embedded form.

**Testing status**
-   **Testing agent used after significant changes:** NO
-   **Test files created:** None
-   **Known regressions:** The Airtable mapping logic and the post-generation Dropbox save functionality are reported as broken by the user.

**Credentials to test flow:**
-   **Admin:**  / 
-   **Dropbox Token:** Located in . **WARNING: This token expires frequently and may need to be replaced.**
-   **Slack Token:** Located in .
-   **Airtable Token:** Located in .

**What agent forgot to execute**
-   The agent has consistently forgotten to inform the user that their Airtable API key may be missing the  permission, which could cause future issues.</analysis>
